{
  "apiVersion": "operator.victoriametrics.com/v1beta1",
  "kind": "VMRule",
  "metadata": {
    "labels": {
      "app": "victoria-metrics-k8s-stack",
      "app.kubernetes.io/instance": "vmks",
      "app.kubernetes.io/managed-by": "Helm",
      "app.kubernetes.io/name": "victoria-metrics-k8s-stack",
      "app.kubernetes.io/version": "v0.28.1",
      "helm.sh/chart": "victoria-metrics-k8s-stack-0.65.1",
      "k8s.joshcorp.co/app": "victoriametrics"
    },
    "name": "vmks-victoria-metrics-k8s-stack-kubernetes-resources",
    "namespace": "victoria-metrics"
  },
  "spec": {
    "groups": [
      {
        "name": "kubernetes-resources",
        "params": {},
        "rules": [
          {
            "alert": "KubeCPUOvercommit",
            "annotations": {
              "description": "Cluster {{ $labels.cluster }} has overcommitted CPU resource requests for Pods by {{ printf \"%.2f\" $value }} CPU shares and cannot tolerate node failure.",
              "runbook_url": "https://runbooks.prometheus-operator.dev/runbooks/kubernetes/kubecpuovercommit",
              "summary": "Cluster has overcommitted CPU resource requests."
            },
            "expr": "(((sum(namespace_cpu:kube_pod_container_resource_requests:sum) by(cluster) - sum(kube_node_status_allocatable{job=\"kube-state-metrics\",resource=\"cpu\"}) by(cluster)) \u003e 0) and (count(max(kube_node_role{job=\"kube-state-metrics\",role=\"control-plane\"}) by(cluster,node)) by(cluster) \u003c 3)) or ((sum(namespace_cpu:kube_pod_container_resource_requests:sum) by(cluster) - ((sum(kube_node_status_allocatable{job=\"kube-state-metrics\",resource=\"cpu\"}) by(cluster) - max(kube_node_status_allocatable{job=\"kube-state-metrics\",resource=\"cpu\"}) by(cluster)) \u003e 0)) \u003e 0)",
            "for": "10m",
            "labels": {
              "severity": "warning"
            }
          },
          {
            "alert": "KubeMemoryOvercommit",
            "annotations": {
              "description": "Cluster {{ $labels.cluster }} has overcommitted memory resource requests for Pods by {{ $value | humanize }} bytes and cannot tolerate node failure.",
              "runbook_url": "https://runbooks.prometheus-operator.dev/runbooks/kubernetes/kubememoryovercommit",
              "summary": "Cluster has overcommitted memory resource requests."
            },
            "expr": "(((sum(namespace_memory:kube_pod_container_resource_requests:sum) by(cluster) - sum(kube_node_status_allocatable{job=\"kube-state-metrics\",resource=\"memory\"}) by(cluster)) \u003e 0) and (count(max(kube_node_role{job=\"kube-state-metrics\",role=\"control-plane\"}) by(cluster,node)) by(cluster) \u003c 3)) or ((sum(namespace_memory:kube_pod_container_resource_requests:sum) by(cluster) - ((sum(kube_node_status_allocatable{job=\"kube-state-metrics\",resource=\"memory\"}) by(cluster) - max(kube_node_status_allocatable{job=\"kube-state-metrics\",resource=\"memory\"}) by(cluster)) \u003e 0)) \u003e 0)",
            "for": "10m",
            "labels": {
              "severity": "warning"
            }
          },
          {
            "alert": "KubeCPUQuotaOvercommit",
            "annotations": {
              "description": "Cluster {{ $labels.cluster }} has overcommitted CPU resource requests for Namespaces.",
              "runbook_url": "https://runbooks.prometheus-operator.dev/runbooks/kubernetes/kubecpuquotaovercommit",
              "summary": "Cluster has overcommitted CPU resource requests."
            },
            "expr": "(sum(min(kube_resourcequota{job=\"kube-state-metrics\",type=\"hard\",resource=~\"(cpu|requests.cpu)\"}) without(resource)) by(cluster) / sum(kube_node_status_allocatable{resource=\"cpu\",job=\"kube-state-metrics\"}) by(cluster)) \u003e 1.5",
            "for": "5m",
            "labels": {
              "severity": "warning"
            }
          },
          {
            "alert": "KubeMemoryQuotaOvercommit",
            "annotations": {
              "description": "Cluster {{ $labels.cluster }} has overcommitted memory resource requests for Namespaces.",
              "runbook_url": "https://runbooks.prometheus-operator.dev/runbooks/kubernetes/kubememoryquotaovercommit",
              "summary": "Cluster has overcommitted memory resource requests."
            },
            "expr": "(sum(min(kube_resourcequota{job=\"kube-state-metrics\",type=\"hard\",resource=~\"(memory|requests.memory)\"}) without(resource)) by(cluster) / sum(kube_node_status_allocatable{resource=\"memory\",job=\"kube-state-metrics\"}) by(cluster)) \u003e 1.5",
            "for": "5m",
            "labels": {
              "severity": "warning"
            }
          },
          {
            "alert": "KubeQuotaAlmostFull",
            "annotations": {
              "description": "Namespace {{ $labels.namespace }} is using {{ $value | humanizePercentage }} of its {{ $labels.resource }} quota on cluster {{ $labels.cluster }}.",
              "runbook_url": "https://runbooks.prometheus-operator.dev/runbooks/kubernetes/kubequotaalmostfull",
              "summary": "Namespace quota is going to be full."
            },
            "expr": "((max(kube_resourcequota{job=\"kube-state-metrics\",type=\"used\"}) without(instance,job,type) / on(cluster,namespace,resource,resourcequota) group_left() (max(kube_resourcequota{job=\"kube-state-metrics\",type=\"hard\"}) without(instance,job,type) \u003e 0)) \u003e 0.9) \u003c 1",
            "for": "15m",
            "labels": {
              "severity": "info"
            }
          },
          {
            "alert": "KubeQuotaFullyUsed",
            "annotations": {
              "description": "Namespace {{ $labels.namespace }} is using {{ $value | humanizePercentage }} of its {{ $labels.resource }} quota on cluster {{ $labels.cluster }}.",
              "runbook_url": "https://runbooks.prometheus-operator.dev/runbooks/kubernetes/kubequotafullyused",
              "summary": "Namespace quota is fully used."
            },
            "expr": "(max(kube_resourcequota{job=\"kube-state-metrics\",type=\"used\"}) without(instance,job,type) / on(cluster,namespace,resource,resourcequota) group_left() (max(kube_resourcequota{job=\"kube-state-metrics\",type=\"hard\"}) without(instance,job,type) \u003e 0)) == 1",
            "for": "15m",
            "labels": {
              "severity": "info"
            }
          },
          {
            "alert": "KubeQuotaExceeded",
            "annotations": {
              "description": "Namespace {{ $labels.namespace }} is using {{ $value | humanizePercentage }} of its {{ $labels.resource }} quota on cluster {{ $labels.cluster }}.",
              "runbook_url": "https://runbooks.prometheus-operator.dev/runbooks/kubernetes/kubequotaexceeded",
              "summary": "Namespace quota has exceeded the limits."
            },
            "expr": "(max(kube_resourcequota{job=\"kube-state-metrics\",type=\"used\"}) without(instance,job,type) / on(cluster,namespace,resource,resourcequota) group_left() (max(kube_resourcequota{job=\"kube-state-metrics\",type=\"hard\"}) without(instance,job,type) \u003e 0)) \u003e 1",
            "for": "15m",
            "labels": {
              "severity": "warning"
            }
          },
          {
            "alert": "CPUThrottlingHigh",
            "annotations": {
              "description": "{{ $value | humanizePercentage }} throttling of CPU in namespace {{ $labels.namespace }} for container {{ $labels.container }} in pod {{ $labels.pod }} on cluster {{ $labels.cluster }}.",
              "runbook_url": "https://runbooks.prometheus-operator.dev/runbooks/kubernetes/cputhrottlinghigh",
              "summary": "Processes experience elevated CPU throttling."
            },
            "expr": "(sum(topk(1, increase(container_cpu_cfs_throttled_periods_total{container!=\"\",job=\"kubelet\",metrics_path=\"/metrics/cadvisor\"}[5m])) by(cluster,namespace,pod,container,instance)) without(id,metrics_path,name,image,endpoint,job,node) / on(cluster,namespace,pod,container,instance) group_left() sum(topk(1, increase(container_cpu_cfs_periods_total{job=\"kubelet\",metrics_path=\"/metrics/cadvisor\"}[5m])) by(cluster,namespace,pod,container,instance)) without(id,metrics_path,name,image,endpoint,job,node)) \u003e 0.25",
            "for": "15m",
            "labels": {
              "severity": "info"
            }
          }
        ]
      }
    ]
  }
}
